<div class="program-page">

  @if (loading()) {
    <div class="loading-info">Ładowanie danych programu...</div>
  }

  @if (!loading()) {

    <!-- Podsumowanie wszystkich semestrów -->
    <div class="total-summary">
      <h1 class="page-title">Program studiów – studia niestacjonarne</h1>
      <span class="total-summary-title">Podsumowanie programu:</span>
      <div class="total-summary-items">
        <div class="total-summary-item">
          <span class="total-summary-label">Łączne ECTS:</span>
          <span class="total-summary-value ects-value">{{ totals().ects }}</span>
        </div>
        <div class="summary-separator"></div>
        <div class="total-summary-item">
          <span class="total-summary-label">Wykłady:</span>
          <span class="total-summary-value">{{ totals().lecture }} h</span>
        </div>
        <div class="total-summary-item">
          <span class="total-summary-label">Ćwiczenia:</span>
          <span class="total-summary-value">{{ totals().tutorial }} h</span>
        </div>
        <div class="total-summary-item">
          <span class="total-summary-label">Laboratoria:</span>
          <span class="total-summary-value">{{ totals().lab }} h</span>
        </div>
        <div class="total-summary-item">
          <span class="total-summary-label">Łącznie godzin:</span>
          <span class="total-summary-value">{{ totals().lecture + totals().tutorial + totals().lab }} h</span>
        </div>
      </div>
    </div>

    <p-tabs [value]="'1'" [scrollable]="true">

      <!-- Lista zakładek -->
      <p-tablist>
        @for (sem of semesters(); track sem.semester) {
          <p-tab [value]="sem.semester.toString()">
            Semestr {{ sem.semester }}
          </p-tab>
        }
      </p-tablist>

      <!-- Zawartość zakładek -->
      <p-tabpanels>
        @for (sem of semesters(); track sem.semester) {
          <p-tabpanel [value]="sem.semester.toString()">

            <!-- Opis semestru -->
            <div class="semester-description">
              @if (sem.description) {
                <p>{{ sem.description }}</p>
              } @else {
                <p class="description-placeholder"><em>Opis programu semestru – do uzupełnienia.</em></p>
              }
            </div>

            <!-- TreeTable z przedmiotami -->
            <p-treeTable
              [value]="sem.nodes"
              [columns]="[]"
              styleClass="p-treetable-sm semester-table"
              [showGridlines]="true"
            >
              <ng-template pTemplate="header">
                <tr>
                  <th style="width: 30%">Nazwa przedmiotu</th>
                  <th style="width: 12%">Typ</th>
                  <th style="width: 6%">Kod</th>
                  <th style="width: 6%" class="text-center">Wykład</th>
                  <th style="width: 6%" class="text-center">Ćwiczenia</th>
                  <th style="width: 6%" class="text-center">Laborat.</th>
                  <th style="width: 8%">Forma zal.</th>
                  <th style="width: 5%" class="text-center">ECTS</th>
                  <th style="width: 11%"></th>
                </tr>
              </ng-template>

              <ng-template pTemplate="body" let-rowNode let-rowData="rowData">
                <tr [ttRow]="rowNode" [class.group-row]="rowData.isGroup" [class.child-row]="rowNode.level > 0 && !rowData.isGroup">
                  <td>
                    <p-treeTableToggler [rowNode]="rowNode" />
                    <span [class.group-label]="rowData.isGroup">{{ rowData.name }}</span>
                  </td>
                  <td>
                    @if (!rowData.isGroup || rowData.type === 'Specjalizacja') {
                      <p-tag
                        [value]="rowData.type"
                        [severity]="rowData.type === 'Obowiązkowy' ? 'info' : rowData.type === 'Obieralny specjalizacji' ? 'success' : rowData.type === 'Specjalizacja' ? 'warn' : 'secondary'"
                        styleClass="type-tag"
                      />
                    }
                  </td>
                  <td>{{ rowData.code }}</td>
                  <td class="text-center">{{ rowData.lecture }}</td>
                  <td class="text-center">{{ rowData.tutorial }}</td>
                  <td class="text-center">{{ rowData.lab }}</td>
                  <td>{{ rowData.form }}</td>
                  <td class="text-center"><strong>{{ rowData.ects }}</strong></td>
                  <td>
                    @if (!rowData.isGroup) {
                      <p-button
                        label="Szczegóły"
                        icon="pi pi-info-circle"
                        size="small"
                        severity="primary"
                        (onClick)="openDetails(rowData)"
                      />
                    }
                  </td>
                </tr>
              </ng-template>
            </p-treeTable>

            <!-- Podsumowanie semestru -->
            <hr class="summary-divider" />
            <div class="semester-summary">
              <div class="summary-item">
                <span class="summary-label">Suma ECTS:</span>
                <span class="summary-value ects-value">{{ sem.totalEcts }}</span>
              </div>
              <div class="summary-separator"></div>
              <div class="summary-item">
                <span class="summary-label">Wykłady:</span>
                <span class="summary-value">{{ sem.totalLecture }} h</span>
              </div>
              <div class="summary-item">
                <span class="summary-label">Ćwiczenia:</span>
                <span class="summary-value">{{ sem.totalTutorial }} h</span>
              </div>
              <div class="summary-item">
                <span class="summary-label">Laboratoria:</span>
                <span class="summary-value">{{ sem.totalLab }} h</span>
              </div>
              <div class="summary-item total-hours">
                <span class="summary-label">Łącznie godzin:</span>
                <span class="summary-value">{{ sem.totalLecture + sem.totalTutorial + sem.totalLab }} h</span>
              </div>
            </div>

          </p-tabpanel>
        }
      </p-tabpanels>

    </p-tabs>
  }

  <!-- Dialog szczegółów przedmiotu -->
  <p-dialog
    [visible]="dialogVisible()"
    (visibleChange)="dialogVisible.set($event)"
    [header]="dialogTitle()"
    [modal]="true"
    [style]="{ width: '860px', maxWidth: '98vw' }"
    [contentStyle]="{ 'max-height': '80vh', 'overflow-y': 'auto' }"
    [draggable]="false"
    [resizable]="false"
    (onHide)="closeDialog()"
  >
    @if (selectedSubject()) {
      @if (sylabusLoading()) {
        <div class="sylabus-loading">
          <p-progressSpinner strokeWidth="4" styleClass="sylabus-spinner" />
          <span>Ładowanie sylabusa...</span>
        </div>
      }
      @if (!sylabusLoading() && !sylabus() && !selectedSubject()!.syllabusFile) {
        <div class="sylabus-brak">
          <p-panel header="Informacje podstawowe" [toggleable]="false" styleClass="sylabus-panel">
            <div class="sylabus-info-grid">
              <span class="info-label">Kod:</span><span>{{ selectedSubject()!.code }}</span>
              <span class="info-label">Typ:</span><span>{{ selectedSubject()!.type }}</span>
              <span class="info-label">Forma zaliczenia:</span><span>{{ selectedSubject()!.form }}</span>
              <span class="info-label">ECTS:</span><span><strong>{{ selectedSubject()!.ects }}</strong></span>
              <span class="info-label">Wykłady / Ćwiczenia / Lab.:</span>
              <span>{{ selectedSubject()!.lecture }}h / {{ selectedSubject()!.tutorial }}h / {{ selectedSubject()!.lab }}h</span>
            </div>
          </p-panel>
          <div class="detail-placeholder">
            <i class="pi pi-info-circle" style="margin-right:0.5rem;"></i>
            <em>Sylabus dla tego przedmiotu nie jest jeszcze dostępny.</em>
          </div>
        </div>
      }
      @if (!sylabusLoading() && !sylabus() && selectedSubject()!.syllabusFile) {
        <div class="detail-placeholder">
          <i class="pi pi-exclamation-triangle" style="margin-right:0.5rem;"></i>
          <em>Nie udało się załadować sylabusa.</em>
        </div>
      }
      @if (!sylabusLoading() && sylabus(); as s) {
        <div class="sylabus-container">
          <p-card styleClass="sylabus-card">
            <ng-template pTemplate="header">
              <div class="sylabus-card-header"><i class="pi pi-book"></i><span>Informacje ogólne</span></div>
            </ng-template>
            <div class="sylabus-info-grid">
              <span class="info-label">Kod przedmiotu:</span><span><strong>{{ s.kod_przedmiotu }}</strong></span>
              <span class="info-label">Kierunek:</span><span>{{ s.kierunek }} · profil {{ s.profil }}</span>
              <span class="info-label">Tryb studiów:</span><span>{{ s.tryb_studiow }}</span>
              <span class="info-label">Rok / Semestr:</span><span>{{ s.rok_studiow }} / {{ s.semestr_studiow }}</span>
              <span class="info-label">Forma:</span><span>{{ s.obligatoryjny ? 'Obowiązkowy' : 'Obieralny' }}</span>
              @if (s.odpowiedzialny_za_przedmiot) {
                <span class="info-label">Odpowiedzialny:</span><span>{{ s.odpowiedzialny_za_przedmiot }}</span>
              }
              <span class="info-label">Wersja z dnia:</span><span>{{ s.wersja_z_dnia }}</span>
            </div>
          </p-card>
          <p-card styleClass="sylabus-card">
            <ng-template pTemplate="header">
              <div class="sylabus-card-header"><i class="pi pi-clock"></i><span>Godziny i punkty ECTS</span></div>
            </ng-template>
            <p-table [value]="[s]" styleClass="p-datatable-sm sylabus-hours-table" [showGridlines]="true">
              <ng-template pTemplate="header">
                <tr>
                  <th>Wykłady</th><th>Ćwiczenia / Lektorat</th><th>Laboratorium / Projekt</th>
                  <th>Z prowadzącym</th><th>Praca własna</th><th>Łącznie</th><th>ECTS</th>
                </tr>
              </ng-template>
              <ng-template pTemplate="body" let-row>
                <tr>
                  <td class="text-center">{{ row.forma_i_liczba_godzin_zajec.wyklady ?? '-' }} h</td>
                  <td class="text-center">{{ row.forma_i_liczba_godzin_zajec.cwiczenia_lektorat_seminarium ?? '-' }} h</td>
                  <td class="text-center">{{ row.forma_i_liczba_godzin_zajec.laboratorium_projekt ?? '-' }} h</td>
                  <td class="text-center">{{ row.godziny.z_udzialem_prowadzacego_h ?? '-' }} h</td>
                  <td class="text-center">{{ row.godziny.praca_wlasna_studenta_h ?? '-' }} h</td>
                  <td class="text-center">{{ row.godziny.calkowita_liczba_godzin_h ?? '-' }} h</td>
                  <td class="text-center"><strong>{{ row.ects }}</strong></td>
                </tr>
              </ng-template>
            </p-table>
          </p-card>
          @if (s.cel_dydaktyczny) {
            <p-panel header="Cel dydaktyczny" [toggleable]="true" [collapsed]="false" styleClass="sylabus-panel">
              <p class="sylabus-text">{{ s.cel_dydaktyczny }}</p>
            </p-panel>
          }
          @if (getZaliczenieEntries(s.zaliczenie).length > 0) {
            <p-panel header="Forma zaliczenia" [toggleable]="true" [collapsed]="false" styleClass="sylabus-panel">
              <p-table [value]="getZaliczenieEntries(s.zaliczenie)" styleClass="p-datatable-sm" [showGridlines]="true">
                <ng-template pTemplate="header"><tr><th style="width:40%">Forma zajęć</th><th>Sposób zaliczenia</th></tr></ng-template>
                <ng-template pTemplate="body" let-row><tr><td>{{ row.forma }}</td><td>{{ row.sposob }}</td></tr></ng-template>
              </p-table>
            </p-panel>
          }
          @if (s.kryteria_oceny?.length) {
            <p-panel header="Kryteria oceny" [toggleable]="true" [collapsed]="true" styleClass="sylabus-panel">
              <ul class="sylabus-list">@for (k of s.kryteria_oceny; track $index) { <li>{{ k }}</li> }</ul>
            </p-panel>
          }
          @if (getMetodyEntries(s.metody_dydaktyczne).length > 0) {
            <p-panel header="Metody dydaktyczne" [toggleable]="true" [collapsed]="true" styleClass="sylabus-panel">
              @for (entry of getMetodyEntries(s.metody_dydaktyczne); track entry.forma) {
                <p class="metody-forma-label">{{ entry.forma }}:</p>
                <ul class="sylabus-list">@for (m of entry.metody; track $index) { <li>{{ m }}</li> }</ul>
              }
            </p-panel>
          }
          @if (s.przedmioty_wprowadzajace?.length) {
            <p-panel header="Przedmioty wprowadzające" [toggleable]="true" [collapsed]="true" styleClass="sylabus-panel">
              <p-table [value]="s.przedmioty_wprowadzajace" styleClass="p-datatable-sm" [showGridlines]="true">
                <ng-template pTemplate="header"><tr><th style="width:40%">Przedmiot</th><th>Wymagane zagadnienia</th></tr></ng-template>
                <ng-template pTemplate="body" let-row><tr><td>{{ row.nazwa }}</td><td>{{ row.wymagania || '–' }}</td></tr></ng-template>
              </p-table>
            </p-panel>
          }
          @if (s.efekty_ksztalcenia) {
            <p-panel header="Efekty kształcenia" [toggleable]="true" [collapsed]="true" styleClass="sylabus-panel">
              @if (asArray(s.efekty_ksztalcenia.wiedza).length) {
                <p class="efekty-kategoria"><i class="pi pi-lightbulb"></i> Wiedza</p>
                <ul class="sylabus-list">@for (e of asArray(s.efekty_ksztalcenia.wiedza); track $index) { <li>{{ e }}</li> }</ul>
              }
              @if (asArray(s.efekty_ksztalcenia.umiejetnosci).length) {
                <p class="efekty-kategoria"><i class="pi pi-cog"></i> Umiejętności</p>
                <ul class="sylabus-list">@for (e of asArray(s.efekty_ksztalcenia.umiejetnosci); track $index) { <li>{{ e }}</li> }</ul>
              }
              @if (asArray(s.efekty_ksztalcenia.kompetencje_spoleczne).length) {
                <p class="efekty-kategoria"><i class="pi pi-users"></i> Kompetencje społeczne</p>
                <ul class="sylabus-list">@for (e of asArray(s.efekty_ksztalcenia.kompetencje_spoleczne); track $index) { <li>{{ e }}</li> }</ul>
              }
            </p-panel>
          }
          @if (s.tresci_programowe?.length) {
            <p-panel header="Treści programowe" [toggleable]="true" [collapsed]="true" styleClass="sylabus-panel">
              <ol class="sylabus-list">@for (t of s.tresci_programowe; track $index) { <li>{{ t }}</li> }</ol>
            </p-panel>
          }
          @if (s.literatura) {
            <p-panel header="Literatura" [toggleable]="true" [collapsed]="true" styleClass="sylabus-panel">
              @if (s.literatura.podstawowa?.pozycje?.length) {
                <p class="literatura-typ">Podstawowa:</p>
                <ul class="sylabus-list">@for (p of s.literatura.podstawowa!.pozycje; track $index) { <li>{{ p }}</li> }</ul>
              }
              @if (s.literatura.uzupelniajaca?.pozycje?.length) {
                <p class="literatura-typ">Uzupełniająca:</p>
                <ul class="sylabus-list">@for (p of s.literatura.uzupelniajaca!.pozycje; track $index) { <li>{{ p }}</li> }</ul>
              }
            </p-panel>
          }
        </div>
      }
    }
    <ng-template pTemplate="footer">
      <p-button label="Zamknij" icon="pi pi-times" (onClick)="closeDialog()" />
    </ng-template>
  </p-dialog>
</div>

